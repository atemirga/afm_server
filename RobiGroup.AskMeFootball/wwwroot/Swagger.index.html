<!-- HTML for static distribution bundle build -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>%(DocumentTitle)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Source+Code+Pro:300,600|Titillium+Web:400,600,700" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./swagger-ui.css">
    <link rel="icon" type="image/png" href="./favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="./favicon-16x16.png" sizes="16x16" />
    <style>
        html {
            box-sizing: border-box;
            overflow: -moz-scrollbars-vertical;
            overflow-y: scroll;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            margin: 0;
            background: #fafafa;
        }

        .header span {
            margin: 5px;
        }
    </style>
    %(HeadContent)
</head>

<body>

    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="position:absolute;width:0;height:0">
        <defs>
            <symbol viewBox="0 0 20 20" id="unlocked">
                <path d="M15.8 8H14V5.6C14 2.703 12.665 1 10 1 7.334 1 6 2.703 6 5.6V6h2v-.801C8 3.754 8.797 3 10 3c1.203 0 2 .754 2 2.199V8H4c-.553 0-1 .646-1 1.199V17c0 .549.428 1.139.951 1.307l1.197.387C5.672 18.861 6.55 19 7.1 19h5.8c.549 0 1.428-.139 1.951-.307l1.196-.387c.524-.167.953-.757.953-1.306V9.199C17 8.646 16.352 8 15.8 8z"></path>
            </symbol>

            <symbol viewBox="0 0 20 20" id="locked">
                <path d="M15.8 8H14V5.6C14 2.703 12.665 1 10 1 7.334 1 6 2.703 6 5.6V8H4c-.553 0-1 .646-1 1.199V17c0 .549.428 1.139.951 1.307l1.197.387C5.672 18.861 6.55 19 7.1 19h5.8c.549 0 1.428-.139 1.951-.307l1.196-.387c.524-.167.953-.757.953-1.306V9.199C17 8.646 16.352 8 15.8 8zM12 8H8V5.199C8 3.754 8.797 3 10 3c1.203 0 2 .754 2 2.199V8z" />
            </symbol>

            <symbol viewBox="0 0 20 20" id="close">
                <path d="M14.348 14.849c-.469.469-1.229.469-1.697 0L10 11.819l-2.651 3.029c-.469.469-1.229.469-1.697 0-.469-.469-.469-1.229 0-1.697l2.758-3.15-2.759-3.152c-.469-.469-.469-1.228 0-1.697.469-.469 1.228-.469 1.697 0L10 8.183l2.651-3.031c.469-.469 1.228-.469 1.697 0 .469.469.469 1.229 0 1.697l-2.758 3.152 2.758 3.15c.469.469.469 1.229 0 1.698z" />
            </symbol>

            <symbol viewBox="0 0 20 20" id="large-arrow">
                <path d="M13.25 10L6.109 2.58c-.268-.27-.268-.707 0-.979.268-.27.701-.27.969 0l7.83 7.908c.268.271.268.709 0 .979l-7.83 7.908c-.268.271-.701.27-.969 0-.268-.269-.268-.707 0-.979L13.25 10z" />
            </symbol>

            <symbol viewBox="0 0 20 20" id="large-arrow-down">
                <path d="M17.418 6.109c.272-.268.709-.268.979 0s.271.701 0 .969l-7.908 7.83c-.27.268-.707.268-.979 0l-7.908-7.83c-.27-.268-.27-.701 0-.969.271-.268.709-.268.979 0L10 13.25l7.418-7.141z" />
            </symbol>


            <symbol viewBox="0 0 24 24" id="jump-to">
                <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7z" />
            </symbol>

            <symbol viewBox="0 0 24 24" id="expand">
                <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
            </symbol>

        </defs>
    </svg>
    
    <div class="swagger-ui">
        <div class="wrapper">

            <section class="block col-12 block-desktop col-12-desktop">
                <section class="models is-open">
                    <h4 class="header">
                        <span>Игра: <span id="user"></span> <span id="title"></span><span id="my-score" style="float: right;"></span><span id="enemy" style="float: right;"></span><span id="enemy-score" style="float: right;"></span></span>
                        <div class="auths"></div>
                    </h4>
                    <div style="height: auto; border: none; margin: 0px; padding: 0px;"><!-- react-text: 481 --> <!-- /react-text -->
                        <div class="block-desktop col-6-desktop">
                            <button id="btn-seacrh" type="button" class="btn hidden">Search</button>
                            <button id="btn-confirm" type="button" class="btn execute">Confirm</button>
                            <button id="btn-accept" type="button" class="btn execute">Accept</button>
                            <button id="btn-cancel" type="button" class="btn cancel">Cancel</button>
                        </div>
                        <div id="question" class="block col-6">
                        </div>
                    </div>
                </section>
            </section>
        </div>
    </div>
    <div id="swagger-ui"></div>

<!-- Workaround for https://github.com/swagger-api/swagger-editor/issues/1371 -->
    <script>
        if (window.navigator.userAgent.indexOf("Edge") > -1) {
            console.log("Removing native Edge fetch in favor of swagger-ui's polyfill")
            window.fetch = undefined;
        }
    </script>
    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="./swagger-ui-bundle.js"></script>
    <script src="./swagger-ui-standalone-preset.js"></script>
<script>

    var _tokens;
    var _token;
    var rival;

    var swaggerUi;

    function requestInterceptorCallback(request) {
        console.log(request);
        if (request.url.indexOf('/token') > -1) {
            request.responseInterceptor = function(res) {
                if (res.ok && res.obj.token) {
                    // swaggerUi.authActions.authorize({ Bearer: { name: 'Bearer', value: 'Bearer ' + res.obj.token }});
                }
            }
        }

        if (_token) {
            request.headers = {
                'Authorization': 'Bearer ' + _token
            };
        }
    }

    function initGame(configObject) {
        if (configObject.env == 'DEV-PC') {
            _tokens = {
                '77070000000':
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjZkYTQ0NDRiLWM1ODMtNDA2Mi04NDVlLTFiNGVkNjAwNDY0OSIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJwbGF5ZXIyIiwiaHR0cDovL3JvYmkuZ3JvdXAvY2xhaW1zL3Bob25lY29uZmlybWVkIjoiVHJ1ZSIsImh0dHA6Ly9yb2JpLmdyb3VwL2NsYWltcy9oYXNwYXNzd29yZCI6IlRydWUiLCJqdGkiOiJiYmY4NWZkMS0yMmRjLTRjOGYtOWVlYi01Mzc3OWQ0YmQzZTciLCJpYXQiOjE1NDE2NjYzMTEsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IkdhbWVyIiwibmJmIjoxNTQxNjY2MzExLCJleHAiOjE1NTQ2MjYzMTEsImlzcyI6IkFza01lRm9vdGJhbGxJc3N1ZXIiLCJhdWQiOiJBc2tNZUZvb3RiYWxsQXVkaWVuY2UifQ.D3jFkU9KZF-YSwRPDFjMSoHiSp5P2-T013bVpbqfB84',
                '77078193563':
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6Ijk3ZDU5OTE3LWI0YjktNDA1My1hMTQ2LTA1ZGQwYjY5MzA0ZCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJwbGF5ZXIxIiwiaHR0cDovL3JvYmkuZ3JvdXAvY2xhaW1zL3Bob25lY29uZmlybWVkIjoiVHJ1ZSIsImh0dHA6Ly9yb2JpLmdyb3VwL2NsYWltcy9oYXNwYXNzd29yZCI6IlRydWUiLCJqdGkiOiIwZjk4ZjJmNy01OGNmLTRlZDItOWY4ZC04OWRjMGMwYWIxYjIiLCJpYXQiOjE1NDE2NjY0NDIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IkdhbWVyIiwibmJmIjoxNTQxNjY2NDQyLCJleHAiOjE1NTQ2MjY0NDIsImlzcyI6IkFza01lRm9vdGJhbGxJc3N1ZXIiLCJhdWQiOiJBc2tNZUZvb3RiYWxsQXVkaWVuY2UifQ.vsxnrB7IaeU1_HfDxFRwKpd1x4_F5vjr6P8ysPe_RwA'
            }
        } else if (configObject.env == 'BEYBITWIN10') {
            _tokens = {
                '77078193563':
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjdlMWQwNTMxLTU0ZjQtNDcxZS04MzU0LTYxZWE1YjQ2YjdmOCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJwbGF5ZXIwMSIsImh0dHA6Ly9yb2JpLmdyb3VwL2NsYWltcy9waG9uZWNvbmZpcm1lZCI6IlRydWUiLCJodHRwOi8vcm9iaS5ncm91cC9jbGFpbXMvaGFzcGFzc3dvcmQiOiJGYWxzZSIsImp0aSI6IjUyNDgwYTdhLTIxMTAtNDYxNC1hNTI2LTE3NWU0NWMzNTExYSIsImlhdCI6MTU0MTI1Nzc0NSwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjoiR2FtZXIiLCJuYmYiOjE1NDEyNTc3NDUsImV4cCI6MTU1NDIxNzc0NSwiaXNzIjoiQXNrTWVGb290YmFsbElzc3VlciIsImF1ZCI6IkFza01lRm9vdGJhbGxBdWRpZW5jZSJ9.DepSeNOItjxsEd0dTm23_FncglL0h4sp8zwZwajyb48',
                '77474828690':
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjA4ZTlmZDhhLTM1OGEtNDMyNi04YzZmLTA0MjE4Yzk4MzFkZCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJwbGF5ZXIxMSIsImh0dHA6Ly9yb2JpLmdyb3VwL2NsYWltcy9waG9uZWNvbmZpcm1lZCI6IlRydWUiLCJodHRwOi8vcm9iaS5ncm91cC9jbGFpbXMvaGFzcGFzc3dvcmQiOiJGYWxzZSIsImp0aSI6IjAzN2UwMjYxLWY1MjYtNGE1Ni1hNjQxLTg4M2FmNzg0MzE4MSIsImlhdCI6MTU0MTI1Nzk0OCwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjoiR2FtZXIiLCJuYmYiOjE1NDEyNTc5NDgsImV4cCI6MTU1NDIxNzk0OCwiaXNzIjoiQXNrTWVGb290YmFsbElzc3VlciIsImF1ZCI6IkFza01lRm9vdGJhbGxBdWRpZW5jZSJ9.yBEVifuBuMJ9XR_QdQnOgX6Zga2GGXyC4qspETOIFic'
            }
        }

        $('.auths').append($('<button type="button" class="btn btn-login" />').text('Login'));

        if (_tokens) {
            for (var token in _tokens) {
                // skip loop if the property is from prototype

                $('.auths').append($('<button type="button" class="btn btn-auth" />').attr('token', token).text('Login ' + token));
            }
        }

        _token = sessionStorage.getItem('token');
        if (_token) {
            authSwaggerCustom(_token);
            $('#user').text(sessionStorage.getItem('user'));
        }

        $('.btn-auth').click(function() {
            var username = $(this).attr('token');
            _token = _tokens[username];
            sessionStorage.setItem('user', username);
            authSwaggerCustom(_token);
        });

        $('.btn-login').click(function () {

            var phone = prompt('Enter phone number:');
            var password = prompt('Enter password:');

            $.ajax({
                url: '/token',
                method: 'GET',
                data: {
                    username: phone,
                    password: password
                }
            }).done(function(response) {
                _token = response.token;
                sessionStorage.setItem('user', response.nickname);
                authSwaggerCustom(_token);
                $('#user').text(response.nickname);
            });
        });

        $.ajaxSetup({
            beforeSend: function (xhr)
            {
                xhr.setRequestHeader("Accept","application/json");
                xhr.setRequestHeader("Authorization","Bearer " + _token);        
            }
        });

        $('#btn-accept, #btn-seacrh, #btn-confirm, #btn-cancel').hide();


        $('#btn-seacrh').click(function() {
            $('#title').text('Seacrhing game...');
            $('#btn-seacrh').prop("disabled", true);
            $.ajax({
                url: rival ? '/api/match/1/request/' + rival : '/api/match/1/search',
                method: 'POST'
            }).done(function (response) {
                if (response.found) {
                    $('#btn-seacrh').hide();
                    $('#btn-cancel').show();
                    match = response.match;
                    $('#enemy').text(match.gamerName);

                    if (match.isBot) {
                        wsconnection.methods.matchAccepted();
                    }

                } else {
                    $('#title').text('Match not found!');
                }
                
                }).fail(function (response) {
                    $('#title').text(response.responseJSON[""][0]);
                })
            .always(function () {
                $('#btn-seacrh').prop("disabled", false);
            });
        });

        $('#btn-accept').click(function() {
            $('#btn-accept').hide();
            $('#btn-confirm').show();
            $('#title').text('Match accepted!');
            $.ajax({
                url: '/api/match/' + match.matchId + '/accept',
                method: 'POST'
            });
        });

        $('#btn-cancel').click(function () {
            $('#btn-cancel, #btn-accept, #btn-confirm').hide();
            $('#title').text('Match cancelled!');
            $.ajax({
                url: '/api/match/' + match.matchId + '/cancel',
                method: 'POST'
            }).always(function() {
                $('#btn-seacrh').show();
            });
        });

        $('#btn-confirm').click(function() {
            $('#btn-confirm').hide();
            $('#title').text('Match confirmed!');
            $.ajax({
                url: '/api/match/' + match.matchId + '/confirm',
                method: 'POST'
            }).done(function (response) {
                if (response.confirmed) {
                    loadQuestions();
                }
            });
        });
    }

    function loadQuestions() {
        $.ajax({
            url: '/api/match/' + match.matchId + '/questions',
            method: 'GET'
        }).done(function (response) {
            match.questions = response;
            sendReady();
        });
    }

    function sendReady() {
        $.ajax({
            url: '/api/match/' + match.matchId + '/ready',
            method: 'POST'
        }).done(function (response) {
           
        });
    }

    function nextQuestion() {

        if (match.currentQuestion < match.questions.length) {
            var question = match.questions[match.currentQuestion];

            $('#question').empty()
                .append($('<p/>').text(question.text));

            question.answers.forEach(function(item, i) {
                var $answer = $('<button class="btn"></button>').text(item.text).attr('data-id', item.id);
                $answer.click(function() {
                    $('#question button').prop("disabled", true);
                    var answerId = $(this).css('background', '#61affe').attr('data-id');
                    $.ajax({
                        url: '/api/match/' + match.matchId + '/answers',
                        method: 'POST',
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify({
                            "questionId": question.id,
                            "answerId": answerId
                        })
                }).done(function(response) {
                });
                });
                $('#question').append($('<p/>').html($answer));
            });

            match.currentQuestion++;
        } else {
            $('#title').text('END!');

            $.ajax({
                url: '/api/match/' + match.matchId + '/result',
                method: 'GET'
            }).done(function (response) {
                var $res = $('<ul/>');

                for (var key in response) {
                    $res.append($('<li/>').text(key + ': ' + response[key]));
                }

                $('#question').html($res);

                $('#btn-seacrh').prop('disabled', false).show();
                $('#btn-cancel').hide();
            });
        }
    }

    var match;

    var wsconnection;
    function authSwaggerCustom(token) {

        sessionStorage.setItem('token', token);

        if (wsconnection) {
            wsconnection.onDisconnected = undefined;
            wsconnection.socket.close();
        }

        wsconnection = new WebSocketManager((location.protocol == "https:" ? "wss://" : "ws://") + location.host + "/game?token=" + token);

        // optional.
        // called when the connection has been established together with your id.
        wsconnection.onConnected = (id) => {
            appendItem("-> You are now connected! Connection ID: " + wsconnection.id);
            $('#btn-seacrh').show();
            $('#title').text('Online!');
        }
        // optional.
        // called when the connection to the server has been lost.
        wsconnection.onDisconnected = () => {
            appendItem("-> Disconnected!");
        };

        wsconnection.methods.matchRequest = function (request) {
            match = request;
            $('#title').text('Match request?');
            $('#enemy').text(match.gamerName);
            $('#btn-seacrh').hide();
            $('#btn-accept').show();
            $('#btn-cancel').show();
        };

        wsconnection.methods.matchAccepted = function (response) {
            $('#title').text('Match accepted! ');
            $('#btn-confirm').show();
            match.accepted = true;
        };

        wsconnection.methods.matchConfirmed = function (response) {
            if (response.confirmed) {
                match.confirmed = true;
                loadQuestions();
            }
        };

        wsconnection.methods.matchResumed = function (response) {
            if (match.gamerId == response.gamerId) {
                $('#title').text('Match resumed for rival! ');
            }
        };

        wsconnection.methods.matchPaused = function (response) {
            if (match.gamerId == response.gamerId) {
                $('#title').text('Match paused for rival! ');
            }
        };

        wsconnection.methods.matchStoped = function (response) {
            if (match.gamerId == response.gamerId) {
                $('#title').text('Match stoped for rival! ');
            }
        };

        wsconnection.methods.matchCanceled = function (response) {
            $('#title').text('Match CANCELLED by ' + response.gamerId);
            if (!match.started) {
                $('#btn-seacrh').show().prop('disabled', false);
                $('#btn-accept, #btn-confirm, #btn-cancel').hide();
            }
        };

        wsconnection.methods.matchStarted = function (request) {
            console.log('matchStarted at:' + new Date());
            $('#title').text('Match STARTED!!!!! ');
        
            match.started = true;
            match.currentQuestion = 0;

            $('#enemy-score').text(0);
            $('#my-score').text(0);
            nextQuestion();
        };

        wsconnection.methods.questionAnswersResult = function (results) {
            
            results.forEach(function(item, i) {
                        
                if (item.gamerId == match.gamerId) {
                    var enemyScore = parseInt($('#enemy-score').text());
                    $('#enemy-score').text(enemyScore +
                        (item.isCorrect ? match.correctAnswerScore : match.incorrectAnswerScore));
                } else {
                    var myScore = parseInt($('#my-score').text());
                    $('#my-score').text(myScore +
                        (item.isCorrect ? match.correctAnswerScore : match.incorrectAnswerScore));
                    $('button[data-id=' + item.answerId + ']').css('background', item.isCorrect ? '#49cc90' : '#f91100');
                }
            });

            setTimeout(function() {
                nextQuestion();
            }, 1500);
        };
        
        wsconnection.connect();
    }

    window.onload = function () {
        var configObject = JSON.parse('%(ConfigObject)');
        var oauthConfigObject = JSON.parse('%(OAuthConfigObject)');
        
        configObject.requestInterceptor = function (request) {
            if (typeof requestInterceptorCallback === 'function')
                return requestInterceptorCallback(request);
        }

        // Apply mandatory parameters
        configObject.dom_id = "#swagger-ui";
        configObject.presets = [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset];
        configObject.layout = "StandaloneLayout";

        // If oauth2RedirectUrl isn't specified, use the built-in default
        if (!configObject.hasOwnProperty("oauth2RedirectUrl"))
            configObject.oauth2RedirectUrl = window.location.href.replace("index.html", "oauth2-redirect.html");

        // Build a system
        const ui = SwaggerUIBundle(configObject);

        var originalAuthorize = ui.authActions.authorize;
        var originalAuthorizePassword = ui.authActions.authorizePassword;
        ui.authActions.authorize = function(auth) {
            // note that the password doesn't get persisted in state after the originalAuthorize()
            // method is called, so we need to put it back
            // let basic auth do its thing
            originalAuthorize(auth);


            if (typeof authSwaggerCustom === 'function') {
                var bearerToken = auth.Bearer.value.split(' ')[1];
                authSwaggerCustom(bearerToken);
            }


            // modify the auth state to include the password
            //ui.authSelectors.authorized().toJS().Custom.value.password = password;
        }
        swaggerUi = ui;

        // Apply OAuth config
        ui.initOAuth(oauthConfigObject);

        initGame(configObject);
    }
</script>
</body>

</html>